<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Battery Status</title>
        <style>
            body { text-align: center; font-family: Arial, sans-serif; margin: 20px; }
            #battery { width: 100px; }
            #status { font-size: 20px; margin-top: 10px; }
            button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
        </style>
        <script type="text/javascript" src="../dist/microbit.umd.js"></script>
    </head>
    <body>

		<h1> Battery Status </h1>
        <img id="battery" src="../images/batt_empty.png" alt="Battery Level">
        <p id="status">Battery: --%</p>
        <button id="connectBtn">Connect to micro:bit</button>

        <div id="log" style="white-space: pre">

            <script>
                let batteryLevel = 0;
                let checkInterval = 5; // Check every 5 seconds (change as needed)
                

                async function connectToMicrobit() {
		
                    try {
                            const device = await microbit.requestMicrobit(window.navigator.bluetooth, {
                                filters: [{ name: "BBC micro:bit [tatap]" }], // ðŸ”¹ Connect to this specific device
                                // optionalServices: ["6e400001-b5a3-f393-e0a9-e50e24dcca9e"] // ðŸ”¹ UART service UUID
                            });

                            // const server = await device.gatt.connect();
                            if (device) {
                                
                                const services = await microbit.getServices(device);
                                
                                console.log("Connected to:", device.name);

                                if (services.uartService) {
                                    
                                    console.log("Connected to micro:bit UART Service!");
                                  
                                    services.uartService.addEventListener("receiveText", (event) => {
                                        console.log("Received from micro:bit:", event.detail);
                                        batteryLevel = parseInt(event.detail.trim(), 10);
                                        console.log("Received battery level:", batteryLevel);                                      
                                        updateBatteryUI(); // Call a function to process received text
                                    });
                                }                                

                                
                                
                                // Store service reference and start listening
                                
                            }
    
                        } catch (error) {
                            console.error("Connection failed:", error);
                        }
                }

                // async function setupUartListener(services) {
                //     try {
                        
                //         // Set up the event listener for receiving data


                //         // // Enable notifications to receive data updates
                //         // await uartCharacteristic.startNotifications();
                //         // console.log("UART notifications started.");
                //     } catch (error) {
                //         console.error("Error setting up UART listener:", error);
                //     }
                // }

                function updateBatteryUI() {
                    let batteryImg = "battery-empty.png";
                    if (batteryLevel > 75) batteryImg = "battery_100.png";
                    else if (batteryLevel > 50) batteryImg = "battery_75.png";
                    else if (batteryLevel > 25) batteryImg = "battery_50.png";
                    else if (batteryLevel > 0) batteryImg = "battery_25.png";

                    document.getElementById("battery").src = '../images/' + batteryImg;
                    document.getElementById("status").innerText = `Battery: ${batteryLevel}%`;
                }

                document.getElementById('connectBtn').addEventListener('click', function() {
                    connectToMicrobit();
                });

                // document.getElementById("connect").onclick = async () => {
                //     const device = await microbit.requestMicrobit(window.navigator.bluetooth);
                //     if (device) {
                //         const services = await microbit.getServices(device);


                //         if (services.uartService) {
                        
                //             // services.uartService.addEventListener("receiveText", eventHandler);
                //             services.uartService.addEventListener("receiveText", (event) => {
                //                 console.log("Received from micro:bit:", event.detail);
                //             });
                            
                //             // await services.uartService.send(new Uint8Array([104, 101, 108, 108, 111, 35])); // hello#
                //             await services.uartService.send("hello#");
                //         }


                //     }
                // }

            </script>

        </div>
    </body>
</html>
