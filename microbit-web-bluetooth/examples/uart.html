<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Battery Status</title>
        <style>
            /* body { text-align: center; font-family: Arial, sans-serif; margin: 20px; } */
            #battery { width: 100px; }
            #status { font-size: 20px; margin-top: 10px; }
            button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
        </style>
        <script type="text/javascript" src="../dist/microbit.umd.js"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    </head>
    <body class="d-flex justify-content-center align-items-center vh-100">
        <div class="container">
            <h1> Battery Status </h1>
            <img id="battery" src="../images/batt_empty.png" alt="Battery Level">
            <p id="status">Battery: --%</p>

            <button id="connectBtn">Connect to micro:bit</button>

            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="flexSwitchCheckDefault">
                <label class="form-check-label" for="flexSwitchCheckDefault">Connect to micro:bit</label>
            </div>
        </div>
        <script>
            let batteryLevel = 0;
            let checkInterval = 5; // Check every 5 seconds (change as needed)
            

            async function connectToMicrobit() {
    
                try {
                        const device = await microbit.requestMicrobit(window.navigator.bluetooth, {
                            filters: [{ name: "BBC micro:bit [tatap]" }], // ðŸ”¹ Connect to this specific device
                            // optionalServices: ["6e400001-b5a3-f393-e0a9-e50e24dcca9e"] // ðŸ”¹ UART service UUID
                        });

                        // const server = await device.gatt.connect();
                        if (device) {
                            
                            const services = await microbit.getServices(device);
                            
                            console.log("Connected to:", device.name);

                            if (services.uartService) {
                                
                                console.log("Connected to micro:bit UART Service!");
                                
                                services.uartService.addEventListener("receiveText", (event) => {
                                    // console.log("Received from micro:bit:", event.detail);
                                    batteryLevel = parseInt(event.detail.trim(), 10);

                                    if (!isNaN(batteryLevel)) {
                                        updateBatteryUI(); // Call a function to process received text
                                    } else {
                                        console.log("Invalid battery level received:", event.detail.trim());                                      
                                    }
                                    
                                });
                            }                                
                            
                        }

                    } catch (error) {
                        console.error("Connection failed:", error);
                    }
            }

            function updateBatteryUI() {
                let batteryImg = "batt_empty.png";
                if (batteryLevel > 75) batteryImg = "batt_100.png";
                else if (batteryLevel > 50) batteryImg = "batt_75.png";
                else if (batteryLevel > 25) batteryImg = "batt_50.png";
                else if (batteryLevel > 0) batteryImg = "batt_25.png";

                document.getElementById("battery").src = "../images/" + batteryImg;
                document.getElementById("status").innerText = `Battery: ${batteryLevel}%`;
            }

            document.getElementById('connectBtn').addEventListener('click', function() {
                connectToMicrobit();
            });

        </script>
    </body>
</html>
